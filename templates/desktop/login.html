{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Acesso Operacional | Quick Delivery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body { background: #f4f7f6; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 100%; max-width: 400px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header-box { background: #11111d; color: white; padding: 30px; text-align: center; }
        .body-box { background: white; padding: 30px; }
        .hidden { display: none; }
        .btn-primary { background: #0d6efd; border: none; padding: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div class="login-card">
    <div class="header-box">
        <i class="bi bi-box-seam fs-1"></i>
        <h4 class="mt-2 mb-0">QUICK DELIVERY</h4>
        <small class="opacity-75">Painel Operacional</small>
    </div>
    
    <div class="body-box">
        <div id="alert-msg" class="alert alert-danger hidden"></div>

        <div id="step-cpf">
            <label class="form-label small fw-bold">DIGITE SEU CPF</label>
            <input type="text" id="input-cpf" class="form-control mb-3" placeholder="000.000.000-00">
            <button onclick="verificarCPF()" class="btn btn-primary w-100">Verificar Acesso</button>
            
        </div>

        <div id="step-login" class="hidden">
            <p class="small text-muted mb-3">Olá, <span id="user-name-login" class="fw-bold text-dark"></span>! Digite sua senha.</p>
            <input type="password" id="input-senha-login" class="form-control mb-3" placeholder="Sua senha">
            <button onclick="fazerLogin()" class="btn btn-primary w-100">Entrar no Painel</button>
            <p class="mt-2 mb-2 small text-muted text-center">Bem vindo ao sistema de Gestão</p>
        </div>

        <div id="step-cadastro" class="hidden">
            <p class="small text-success mb-3 fw-bold"><i class="bi bi-star"></i> Bem-vindo! Crie sua senha de acesso.</p>
            <input type="password" id="pass1" class="form-control mb-2" placeholder="Nova Senha">
            <input type="password" id="pass2" class="form-control mb-3" placeholder="Confirme a Senha">
            <button onclick="cadastrarSenha()" class="btn btn-success w-100 p-2 fw-bold">Cadastrar Senha</button>
            <p class="mt-2 mb-2 small text-muted text-center">Bem vindo ao sistema de Gestão</p>
        </div>
    </div>
</div>

<script>
let globalCPF = "";

function showAlert(msg) {
    const box = document.getElementById('alert-msg');
    box.innerText = msg;
    box.classList.remove('hidden');
}

async function callAPI(body) {
    const response = await fetch("{% url 'operacional:login_operacional' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify(body)
    });
    return response;
}

async function verificarCPF() {
    globalCPF = document.getElementById('input-cpf').value;
    const res = await callAPI({ cpf: globalCPF, acao: 'verificar' });
    const data = await res.json();

    if (res.ok) {
        document.getElementById('step-cpf').classList.add('hidden');
        document.getElementById('alert-msg').classList.add('hidden');

        if (data.status === 'usuario_registrado') {
            document.getElementById('step-login').classList.remove('hidden');
            document.getElementById('user-name-login').innerText = data.nome;
        } else {
            document.getElementById('step-cadastro').classList.remove('hidden');
        }
    } else {
        showAlert(data.message);
    }
}

async function fazerLogin() {
    const senha = document.getElementById('input-senha-login').value;
    const res = await callAPI({ cpf: globalCPF, senha: senha, acao: 'login' });
    const data = await res.json();

    if (res.ok) window.location.href = data.url;
    else showAlert(data.message);
}

async function cadastrarSenha() {
    const p1 = document.getElementById('pass1').value;
    const p2 = document.getElementById('pass2').value;

    if (p1 !== p2 || p1.length < 4) {
        showAlert("As senhas não conferem ou são muito curtas.");
        return;
    }

    const res = await callAPI({ cpf: globalCPF, senha: p1, acao: 'cadastrar' });
    const data = await res.json();

    if (res.ok) window.location.href = data.url;
    else showAlert(data.message);
}
</script>
</body>
</html>