{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% progressive_web_app_meta %}
    <link rel="apple-touch-icon" href="/static/images/icon-160x160.png">
    <title>App Motorista - Rotas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="{% static 'css/app_v1.css' %}" rel="stylesheet">
    <style>
        /* Estilos Customizados para Mobile */
        body { background-color: #f4f4f9; }
        .card-manifesto { border-left: 5px solid #dc3545; }
        .card-nf { border-left: 3px solid #0d6efd; margin-top: 15px; }
        .header-status { background-color: #dc3545; color: white; padding: 10px; border-radius: 5px 5px 0 0; }
        .loading-animation { width: 50px; height: 50px; }
    </style>
</head>
<body>
<header class="app-header fixed-top bg-white shadow-sm">
    <div class="container-fluid h-100 d-flex align-items-center justify-content-between px-3">

        <!-- LADO ESQUERDO -->
        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-menu" type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#sidebarMenu">
                <i class="bi bi-list"></i>
            </button>

            <div class="brand-area">
                <span class="brand-title">Transportadora App</span>
                <span class="brand-subtitle">Opera√ß√£o Log√≠stica</span>
            </div>
        </div>

        <!-- LADO DIREITO -->
        <div class="d-flex align-items-center gap-3">

            <!-- STATUS -->
            <div class="status-indicator d-none d-sm-flex">
                <span class="status-dot"></span>
                <span class="status-text">Online</span>
            </div>

            <!-- USU√ÅRIO -->
            <div class="dropdown">
                <button class="btn btn-user dropdown-toggle" data-bs-toggle="dropdown">
                    <div class="user-info d-none d-sm-block text-end">
                        <span class="user-name" id="header-nome-motorista">Motorista</span>
                        <span class="user-role">Motorista</span>
                    </div>
                    <div class="avatar-circle">
                        <i class="bi bi-person-fill" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                </button>

                <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                    <li>
                        <a class="dropdown-item" href="#">
                            <i class="bi bi-person me-2"></i> Meu Perfil
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#">
                            <i class="bi bi-gear me-2"></i> Configura√ß√µes
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item text-danger" href="#">
                            <i class="bi bi-box-arrow-right me-2"></i> Sair
                        </a>
                    </li>
                </ul>
            </div>

        </div>
    </div>
</header>

<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold" id="sidebarMenuLabel text-primary">Menu Principal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action py-3" onclick="location.reload()">
                <i class="bi bi-house-door me-2"></i> In√≠cio / Notas
            </a>
            <a href="javascript:void(0)" onclick="abrirHistorico()" class="list-group-item list-group-item-action py-3">
    <i class="bi bi-clock-history me-2"></i> Hist√≥rico de Entregas
</a>
            <a href="#" class="list-group-item list-group-item-action py-3 border-top mt-auto text-danger" onclick="logout()">
                <i class="bi bi-box-arrow-left me-2"></i> Sair do App
            </a>
        </div>
    </div>
</div>


  <div id="full-screen-camera" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;">
    <video id="video-full" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
    
    <div style="position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center;">
        <button type="button" class="btn btn-light rounded-circle" onclick="capturarFotoFull()" style="width: 70px; height: 70px; border: 5px solid rgba(0,0,0,0.2);">
            <i class="bi bi-camera-fill fs-2"></i>
        </button>
        <button type="button" class="btn btn-danger rounded-pill ms-3" onclick="fecharCameraFull()" style="position: absolute; top: 15px; right: 20px;">
            Sair
        </button>
    </div>
</div>
    <div class="container d-flex flex-column min-vh-100 justify-content-center ">
    <div id="app-content">
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status" id="loadingSpinner">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2" id="loadingMessage">Verificando status...</p>
        </div>

        <div class="mt-5">
            <form id="search-form">
              <input
    type="text"
    id="manifesto-number"
    class="form-control"
    placeholder="N√∫mero do Manifesto"
    required
    inputmode="numeric"
    pattern="[0-9]*"
    oninput="this.value = this.value.replace(/\D/g, '')"
/>

                <button type="submit" class="btn btn-primary mt-3">Buscar Manifesto</button>
            </form>
        </div>
    </div>

    <div class="fixed-bottom p-3 bg-light border-top d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Sair do App</button>
        <p class="text-muted small my-0">DEV: Luiz Gustavo Ver: 0.1</p>
        <p class="text-muted small my-0"><a href="https://wa.me/5521980064787" target="_blank" rel="noopener noreferrer">Precisa de Ajuda?</a></p>
    </div>
</div>
    
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary loading-animation" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <h5 class="mt-3" id="loadingModalLabel">Buscando Manifesto...</h5>
            <p>Validando dados do manifesto...</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="kmFinalModal" tabindex="-1" aria-labelledby="kmFinalModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger fw-bold" id="kmFinalModalLabel">Finaliza√ß√£o de Jornada</h5>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3 small text-center">Parabens por concluir a jornada.</p>
        <p class="text-muted small text-center">Informe o KM final para finalizar a jornada.</p>
        <form id="finalizar-form-modal">
            <input type="number" id="km-final" class="form-control mb-3" placeholder="KM Final (Obrigat√≥rio)" required>
            <div id="finalizar-message" class="text-danger small mb-2"></div>
            <button type="submit" class="btn btn-danger w-100">Finalizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ocorrenciaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">

      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-file-earmark-text"></i>
          Registrar Ocorr√™ncia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="mb-3">
          <label class="form-label">Data da Ocorr√™ncia</label>
          <input type="date" id="ocorrencia-data" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Selecione a Ocorr√™ncia</label>
          <select id="ocorrencia-tipo" class="form-select">
            <option value="ENTREGA_REALIZADA">Entrega Realizada</option>
            <option value="DEVOLUCAO">Devolu√ß√£o</option>
            <option value="AVARIA">Avaria</option>
          </select>
        </div>

        <textarea id="ocorrencia-comentario"
          class="form-control mb-3"
          placeholder="Coment√°rio (Opcional)"></textarea>

        <!-- üì∏ ANEXO -->
        <div class="text-center mb-3">
          <label class="form-label d-block">Anexar Foto (Opcional)</label>

          <input
            type="file"
            id="foto-ocorrencia"
            accept="image/*"
            capture="environment"
            hidden
          >

          <button
            class="btn btn-outline-primary"
            onclick="abrirCamera()">
            <i class="bi bi-paperclip"></i>
          </button>
        </div>

        <!-- PREVIEW -->
        <div id="preview-container" class="text-center d-none">
          <img id="preview-img" class="img-thumbnail mb-2" style="max-width: 200px;">
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-sm btn-secondary" onclick="visualizarImagem()">Visualizar</button>
            <button class="btn btn-sm btn-warning" onclick="tirarOutraFoto()">Tirar outra</button>
          </div>
        </div>

      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarOcorrencia()">Confirmar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalBaixa" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modal-titulo-nf" class="text-truncate">Registro Ocorr√™ncia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hidden-chave-nf">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Selecione a Ocorr√™ncia:</label>
                    <select class="form-select" id="select-ocorrencia">
                        <optgroup label="ENTREGA (Obrigat√≥rio Foto)">
                            <option value="1">1 - Entrega Realizada Normalmente</option>
                            <option value="2">2 - Entrega com restri√ß√£o ou parcial</option>
                        </optgroup>
                        <optgroup label="N√ÉO ENTREGA (Foto Opcional)">
                            <option value="44">44 - Tempo de espera excedido</option>
                            <option value="21">21 - Estabelecimento Fechado</option>
                            <option value="20">20 - Falta de tempo h√°bil</option>
                            <option value="39">39 - Fora de agendamento</option>
                            <option value="14">14 - Mercadoria sinistrada</option>
                            <option value="31">31 - Produto fora da temperatura</option>
                            <option value="125">125 - Cliente se recusou a receber</option>
                            <option value="6">6 - Endere√ßo n√£o localizado</option>
                            <option value="126">126 - Endere√ßo localizado ‚Äì cliente ausente</option>
                            <option value="127">127 - Endere√ßo localizado ou divergente</option>
                            <option value="85">85 - Apreens√£o Fiscal</option>
                            <option value="26">26 - Recusa por desconhecer o pedido</option>
                        </optgroup>
                    </select>
                </div>

                <div class="mb-3" id="campo-recebedor">
                    <label class="form-label fw-bold">Nome do Recebedor:</label>
                    <input type="text" class="form-control" id="input-recebedor" placeholder="Quem recebeu?">
                </div>

                <div class="camera-container border rounded bg-light text-center p-2 mb-3" style="min-height: 200px; position: relative;">
                    
                    <canvas id="canvas-preview" style="width: 100%; display: none; border-radius: 8px;"></canvas>
                    
                    <div id="placeholder-camera" class="py-5">
                        <i class="bi bi-camera" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted">A foto ser√° exibida aqui</p>
                    </div>
                </div>

                <div class="d-grid gap-2">
    <label for="camera-nativa" class="btn btn-outline-secondary" id="label-camera">
        <i class="bi bi-camera-fill"></i> Abrir C√¢mera
    </label>
    
    <input type="file" id="camera-nativa" accept="image/*" capture="camera" style="display: none;">

    <label for="camera-nativa" class="btn btn-warning" id="btn-nova-foto" style="display: none;">
        Tirar outra foto
    </label>
</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarRegistro()">Confirmar Registro</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Detalhes da Entrega</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-detalhes-body">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="statusModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div id="status-icon" class="mb-3">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            </div>
            <h5 id="status-title">Enviando Registro...</h5>
            <p id="status-message" class="text-muted">Aguarde, estamos salvando os dados e a foto.</p>
            
            <div id="status-footer" style="display: none;" class="mt-3">
                <button type="button" class="btn btn-primary w-100 mb-2" onclick="location.reload()">
                    Entendido / Fechar
                </button>
                <button id="btn-reportar" type="button" class="btn btn-outline-success w-100" style="display: none;">
                    Relatar no WhatsApp
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalUpdate" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="mb-3">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            </div>
            <h5 class="fw-bold">Aplicativo Atualizado!</h5>
            <p class="text-muted">As novas melhorias j√° foram baixadas. Clique em OK para aplicar as altera√ß√µes.</p>
            <div class="mt-3">
                <button type="button" class="btn btn-success w-100 fw-bold" onclick="recarregarPWA()">
                    ENTENDI / OK
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg modal-fullscreen-sm-down">
        <div class="modal-content" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-clock-history me-2 text-primary"></i>Hist√≥rico de Manifestos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="historico-content">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Carregando hist√≥rico...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalSincronismo" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="modal-body" id="modal-sinc-conteudo">
                <div id="modal-sinc-status">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                </div>
                
                <h5 class="fw-bold" id="modal-sinc-titulo">Sincronizando Notas</h5>
                
                <p class="text-muted" id="modal-sinc-mensagem">Estamos buscando novas notas no sistema da ESL. Por favor, aguarde alguns instantes.</p>
                
                <div class="progress mt-3" id="modal-sinc-progresso" style="height: 10px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>

                <button type="button" class="btn btn-secondary mt-3 d-none" id="modal-sinc-btn-fechar" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<span id="manifesto-id-display" style="display: none;"></span>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
 let modalUpdate;

// Garante que o Bootstrap carregou o modal antes de tentar usar
document.addEventListener('DOMContentLoaded', function() {
    modalUpdate = new bootstrap.Modal(document.getElementById('modalUpdate'));
});

if ('serviceWorker' in navigator) {
    // 1. Registra o SW
    navigator.serviceWorker.register('/serviceworker.js').then(reg => {
        
        // 2. Monitora se o SW atualizou e assumiu o controle
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            // Isso dispara quando o novo SW ativa e toma o lugar do antigo
            if (modalUpdate) {
                // Muda o texto do modal dinamicamente antes de mostrar
                document.querySelector('#modalUpdate h5').innerText = "App Atualizado!";
                document.querySelector('#modalUpdate p').innerText = "Sua rota e sistema foram atualizados com sucesso.";
                modalUpdate.show();
            }
        });

        // 3. Caso o navegador detecte a mudan√ßa mas ainda esteja instalando
        reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'activated' && !navigator.serviceWorker.controller) {
                    // Primeiro acesso ou atualiza√ß√£o for√ßada
                    console.log('SW Ativado com sucesso');
                }
            });
        });
    });
}

// Fun√ß√£o de Reinicializa√ß√£o Completa (Bot√£o OK)
async function recarregarPWA() {
    // For√ßa a limpeza total e recarrega na raiz para garantir
    if ('caches' in window) {
        const names = await caches.keys();
        await Promise.all(names.map(name => caches.delete(name)));
    }
    // O reload(true) for√ßa o navegador a ignorar o cache do disco
    window.location.reload(true);
}
</script>
<script src="{% static 'js/serviceworker.js' %}?v=1.3"></script> 
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest"></script>
    <script src="/static/js/login_motorista/authFetch.js"></script>
    <script src="{% static 'js/manifesto_v9.js' %}"></script>
    <script src="{% static 'js/historico_v1.js' %}"></script>

</body>
</html>