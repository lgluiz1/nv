{% load static %}
{% load pwa %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% progressive_web_app_meta %}
    <link rel="apple-touch-icon" href="/static/images/icon-160x160.png">
    <title>App Motorista - Rotas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/app.css' %}" rel="stylesheet">
    <style>
        /* Estilos Customizados para Mobile */
        body { background-color: #f4f4f9; }
        .card-manifesto { border-left: 5px solid #dc3545; }
        .card-nf { border-left: 3px solid #0d6efd; margin-top: 15px; }
        .header-status { background-color: #dc3545; color: white; padding: 10px; border-radius: 5px 5px 0 0; }
        .loading-animation { width: 50px; height: 50px; }
    </style>
</head>
<body>
  <header class="app-header shadow-sm fixed-top bg-white">
    <div class="container-fluid d-flex align-items-center justify-content-between py-2">
        <div class="d-flex align-items-center">
            <button class="btn btn-link text-dark p-0 me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="bi bi-list fs-2"></i>
            </button>
            <div class="brand-area">
                <h1 class="h6 mb-0 fw-bold text-primary">Transportadora App</h1>
                <small class="text-muted d-block" style="font-size: 0.7rem;">Opera√ß√£o Log√≠stica</small>
            </div>
        </div>

        <div class="d-flex align-items-center">
            <div class="text-end me-2 d-none d-sm-block">
                <p class="mb-0 small fw-bold" id="header-nome-motorista">Motorista</p>
                <span class="badge rounded-pill bg-success p-1" style="font-size: 0.6rem;">Online</span>
            </div>
            <div class="avatar-circle">
                <i class="bi bi-person-circle fs-3 text-secondary"></i>
            </div>
        </div>
    </div>
</header>

<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold" id="sidebarMenuLabel text-primary">Menu Principal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body p-0">
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action py-3" onclick="location.reload()">
                <i class="bi bi-house-door me-2"></i> In√≠cio / Notas
            </a>
            <a href="#" class="list-group-item list-group-item-action py-3">
                <i class="bi bi-clock-history me-2"></i> Hist√≥rico de Entregas
            </a>
            <a href="#" class="list-group-item list-group-item-action py-3 border-top mt-auto text-danger" onclick="logout()">
                <i class="bi bi-box-arrow-left me-2"></i> Sair do App
            </a>
        </div>
    </div>
</div>

<div style="margin-top: 75px;"></div>
  <div id="full-screen-camera" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999;">
    <video id="video-full" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
    
    <div style="position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center;">
        <button type="button" class="btn btn-light rounded-circle" onclick="capturarFotoFull()" style="width: 70px; height: 70px; border: 5px solid rgba(0,0,0,0.2);">
            <i class="bi bi-camera-fill fs-2"></i>
        </button>
        <button type="button" class="btn btn-danger rounded-pill ms-3" onclick="fecharCameraFull()" style="position: absolute; top: 15px; right: 20px;">
            Sair
        </button>
    </div>
</div>
    <div class="container py-3 d-flex flex-column min-vh-100 justify-content-center align-items-center">
    <div id="app-content">
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status" id="loadingSpinner">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2" id="loadingMessage">Verificando status...</p>
        </div>

        <div class="mt-5">
            <form id="search-form">
                <input type="number" id="manifesto-number" class="form-control" placeholder="N√∫mero do Manifesto" required>
                <button type="submit" class="btn btn-primary mt-3">Buscar Manifesto</button>
            </form>
        </div>
    </div>

    <div class="fixed-bottom p-3 bg-light border-top d-flex justify-content-between">
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Sair do App</button>
        <p class="text-muted small my-0">DEV: Luiz Gustavo Ver: 0.1</p>
        <p class="text-muted small my-0"><a href="https://wa.me/5521980064787" target="_blank" rel="noopener noreferrer">Precisa de Ajuda?</a></p>
    </div>
</div>
    
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-primary loading-animation" role="status">
              <span class="visually-hidden">Processando...</span>
            </div>
            <h5 class="mt-3" id="loadingModalLabel">Buscando Manifesto...</h5>
            <p>Validando dados do manifesto...</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="kmFinalModal" tabindex="-1" aria-labelledby="kmFinalModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="kmFinalModalLabel">Finaliza√ß√£o de Jornada</h5>
      </div>
      <div class="modal-body">
        <p>Todas as notas foram processadas. Insira a quilometragem final para concluir o manifesto.</p>
        <form id="finalizar-form-modal">
            <input type="number" id="km-final" class="form-control mb-3" placeholder="KM Final (Obrigat√≥rio)" required>
            <div id="finalizar-message" class="text-danger small mb-2"></div>
            <button type="submit" class="btn btn-danger w-100">Confirmar e Finalizar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="ocorrenciaModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">

      <div class="modal-header border-0">
        <h5 class="modal-title">
          <i class="bi bi-file-earmark-text"></i>
          Registrar Ocorr√™ncia
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="mb-3">
          <label class="form-label">Data da Ocorr√™ncia</label>
          <input type="date" id="ocorrencia-data" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Selecione a Ocorr√™ncia</label>
          <select id="ocorrencia-tipo" class="form-select">
            <option value="ENTREGA_REALIZADA">Entrega Realizada</option>
            <option value="DEVOLUCAO">Devolu√ß√£o</option>
            <option value="AVARIA">Avaria</option>
          </select>
        </div>

        <textarea id="ocorrencia-comentario"
          class="form-control mb-3"
          placeholder="Coment√°rio (Opcional)"></textarea>

        <!-- üì∏ ANEXO -->
        <div class="text-center mb-3">
          <label class="form-label d-block">Anexar Foto (Opcional)</label>

          <input
            type="file"
            id="foto-ocorrencia"
            accept="image/*"
            capture="environment"
            hidden
          >

          <button
            class="btn btn-outline-primary"
            onclick="abrirCamera()">
            <i class="bi bi-paperclip"></i>
          </button>
        </div>

        <!-- PREVIEW -->
        <div id="preview-container" class="text-center d-none">
          <img id="preview-img" class="img-thumbnail mb-2" style="max-width: 200px;">
          <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-sm btn-secondary" onclick="visualizarImagem()">Visualizar</button>
            <button class="btn btn-sm btn-warning" onclick="tirarOutraFoto()">Tirar outra</button>
          </div>
        </div>

      </div>

      <div class="modal-footer border-0">
        <button class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarOcorrencia()">Confirmar</button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalBaixa" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modal-titulo-nf" class="text-truncate">Registro Ocorr√™ncia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="hidden-chave-nf">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Selecione a Ocorr√™ncia:</label>
                    <select class="form-select" id="select-ocorrencia">
                        <optgroup label="ENTREGA (Obrigat√≥rio Foto)">
                            <option value="1">1 - Entrega Realizada Normalmente</option>
                            <option value="2">2 - Entrega com restri√ß√£o ou parcial</option>
                        </optgroup>
                        <optgroup label="N√ÉO ENTREGA (Foto Opcional)">
                            <option value="44">44 - Tempo de espera excedido</option>
                            <option value="21">21 - Estabelecimento Fechado</option>
                            <option value="20">20 - Falta de tempo h√°bil</option>
                            <option value="39">39 - Fora de agendamento</option>
                            <option value="14">14 - Mercadoria sinistrada</option>
                            <option value="31">31 - Produto fora da temperatura</option>
                            <option value="125">125 - Cliente se recusou a receber</option>
                            <option value="6">6 - Endere√ßo n√£o localizado</option>
                            <option value="126">126 - Endere√ßo localizado ‚Äì cliente ausente</option>
                            <option value="127">127 - Endere√ßo localizado ou divergente</option>
                            <option value="85">85 - Apreens√£o Fiscal</option>
                            <option value="26">26 - Recusa por desconhecer o pedido</option>
                        </optgroup>
                    </select>
                </div>

                <div class="mb-3" id="campo-recebedor">
                    <label class="form-label fw-bold">Nome do Recebedor:</label>
                    <input type="text" class="form-control" id="input-recebedor" placeholder="Quem recebeu?">
                </div>

                <div class="camera-container border rounded bg-light text-center p-2 mb-3" style="min-height: 200px; position: relative;">
                    
                    <canvas id="canvas-preview" style="width: 100%; display: none; border-radius: 8px;"></canvas>
                    
                    <div id="placeholder-camera" class="py-5">
                        <i class="bi bi-camera" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted">A foto ser√° exibida aqui</p>
                    </div>
                </div>

                <div class="d-grid gap-2">
    <label for="camera-nativa" class="btn btn-outline-secondary" id="label-camera">
        <i class="bi bi-camera-fill"></i> Abrir C√¢mera
    </label>
    
    <input type="file" id="camera-nativa" accept="image/*" capture="camera" style="display: none;">

    <label for="camera-nativa" class="btn btn-warning" id="btn-nova-foto" style="display: none;">
        Tirar outra foto
    </label>
</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarRegistro()">Confirmar Registro</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> Detalhes da Entrega</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-detalhes-body">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'js/serviceworker.js' %}"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/login_motorista/authFetch.js"></script>
    <script src="{% static 'js/manifesto.js' %}?v=1.0.2"></script>
</body>
</html>